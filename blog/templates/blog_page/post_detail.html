{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">{{ post.title }}</h1>
    
    <div class="post-meta mb-3">
        <span class="author">작성자: {{ post.author }}</span>
        <span class="date">날짜: {{ post.created_at|date:"Y-m-d H:i" }}</span>
        <span class="views">조회수: {{ post.views_count }}</span>
    </div>

    {% if post.category %}
    <div class="post-category mb-2">
        카테고리: <a href="{% url 'blog_page:category_page' post.category.slug %}">{{ post.category }}</a>
    </div>
    {% endif %}

    <div class="post-status mb-2">
        상태: {{ post.get_status_display }}
    </div>

    <div class="post-tags mb-3">
        {% for tag in post.tags.all %}
        <a href="{% url 'blog_page:tag_page' tag.slug %}" class="badge bg-secondary">{{ tag.name }}</a>
        {% endfor %}
    </div>

    <div class="post-content mb-4">
        {{ post.content|safe }}
    </div>

    {% if user.is_authenticated and user == post.author %}
    <div class="post-actions mb-4">
        <a href="{% url 'blog_page:post_edit' post.pk %}" class="btn btn-primary">수정하기</a>
        <form action="{% url 'blog_page:post_delete' post.pk %}" method="post" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger" onclick="return confirm('정말로 이 게시물을 삭제하시겠습니까?');">삭제하기</button>
        </form>
    </div>
    {% endif %}

    {% csrf_token %}
    <div class="post-interactions mb-4">
        <div class="like-section">
            <button id="like-button" class="btn btn-outline-primary" data-post-id="{{ post.pk }}">
                {% if user.is_authenticated and post.is_liked_by_user %}
                좋아요 취소
                {% else %}
                좋아요
                {% endif %}
            </button>
            <span id="like-count">{{ post.total_likes }}</span> 명이 좋아합니다
        </div>

        <div class="bookmark-section mt-2">
            <button id="bookmark-button" class="btn btn-outline-secondary" data-post-id="{{ post.pk }}">
                {% if user.is_authenticated and post.is_bookmarked_by_user %}
                북마크 취소
                {% else %}
                북마크
                {% endif %}
            </button>
            <span id="bookmark-count">{{ post.bookmark_set.count }}</span> 명이 북마크했습니다
        </div>
    </div>

    <div class="comments-section">
        <h3>댓글</h3>
        {% for item in comment_tree %}
            <div class="comment" id="comment-{{ item.comment.id }}">
                <p>{{ item.comment.content }}</p>
                <small>
                    작성자: {{ item.comment.author }} | 
                    날짜: {{ item.comment.created_at|date:"Y-m-d H:i" }}
                </small>
                {% if user == item.comment.author %}
                    <a href="{% url 'blog_page:comment_update' item.comment.id %}" class="btn btn-sm btn-primary">수정</a>
                    <form action="{% url 'blog_page:delete_comment' item.comment.id %}" method="post" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('정말로 이 댓글을 삭제하시겠습니까?');">삭제</button>
                    </form>
                {% endif %}
                <button class="reply-button btn btn-sm btn-secondary" data-comment-id="{{ item.comment.id }}">답글</button>
                
                <div class="reply-form" id="reply-form-{{ item.comment.id }}" style="display: none;">
                    <form method="post" action="{% url 'blog_page:post_detail' post.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="parent_id" value="{{ item.comment.id }}">
                        {{ comment_form.content }}
                        <button type="submit" class="btn btn-primary">답글 작성</button>
                    </form>
                </div>
    
                {% if item.replies %}
                    <div class="replies" style="margin-left: 20px;">
                        {% for reply in item.replies %}
                            <div class="comment" id="comment-{{ reply.id }}">
                                <p>{{ reply.content }}</p>
                                <small>
                                    작성자: {{ reply.author }} | 
                                    날짜: {{ reply.created_at|date:"Y-m-d H:i" }}
                                </small>
                                {% if user == reply.author %}
                                    <a href="{% url 'blog_page:comment_update' reply.id %}" class="btn btn-sm btn-primary">수정</a>
                                    <form action="{% url 'blog_page:delete_comment' reply.id %}" method="post" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('정말로 이 댓글을 삭제하시겠습니까?');">삭제</button>
                                    </form>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        {% empty %}
            <p>댓글이 없습니다.</p>
        {% endfor %}
    
        {% if user.is_authenticated %}
            <h4>새 댓글 작성</h4>
            <form method="post" action="{% url 'blog_page:post_detail' post.pk %}">
                {% csrf_token %}
                {{ comment_form.as_p }}
                <button type="submit" class="btn btn-primary">댓글 작성</button>
            </form>
        {% else %}
            <p>댓글을 작성하려면 <a href="{% url 'accounts:login' %}">로그인</a>해주세요.</p>
        {% endif %}
    </div>
    {% endblock %}
    
    {% block extra_js %}
    <script src="{% static 'js/comments.js' %}"></script>
    <script src="{% static 'js/post_detail.js' %}"></script>
    {% endblock %}